{% extends "base.html" %}

{% block title %}{{ _('printer_setup_title') }} – PrintFleet{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h2 class="h5 mb-0">
      {{ _('printer_setup_title') }}
    </h2>

    <div class="d-flex flex-wrap gap-2">
      <!-- Neuer Drucker -->
      <a href="{{ url_for('printers.printer_new') }}" class="btn btn-primary btn-sm">
        {{ _('printer_new_button') }}
      </a>

      <!-- Export Button -->
      <a href="{{ url_for('export.export_printers') }}" class="btn btn-outline-secondary btn-sm">
        {{ _('btn_export_printers') }}
      </a>

      <!-- Import-Formular -->
      <form
        method="post"
        action="{{ url_for('export.import_printers') }}"
        enctype="multipart/form-data"
        class="d-flex align-items-center gap-2"
      >
        <input
          type="file"
          name="file"
          accept=".json"
          required
          class="form-control form-control-sm"
          style="max-width: 220px;"
        >
        <button type="submit" class="btn btn-outline-secondary btn-sm">
          {{ _('btn_import_printers') }}
        </button>
      </form>
    </div>
  </div>

  <div class="card-body p-2">
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm align-middle mb-0" id="printerSetupTable">
        <thead>
          <tr>
            <th>{{ _('col_printer_name') }}</th>
            <th>{{ _('col_backend') }}</th>
            <th>{{ _('col_host') }}</th>
            <th>{{ _('col_location') if _ else 'Location' }}</th>
            <th>{{ _('col_printer_type') if _ else 'Printer type' }}</th>
            <th>{{ _('col_tasmota_host') if _ else 'Tasmota Host' }}</th>
            <th class="text-center">{{ _('col_enabled') if _ else 'Enabled' }}</th>
            <th class="text-end">{{ _('col_actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for p in printers %}
          <tr>
            <!-- Name + ggf. Notiz-Icon -->
            <td>
              {{ p.name }}
              {% if p.notes %}
                <i
                  class="bi bi-sticky ms-1 text-muted"
                  title="{{ p.notes }}"
                ></i>
              {% endif %}
            </td>

            <td>{{ p.backend }}</td>
            <td>{{ p.host }}</td>

            <!-- Standort -->
            <td>{{ p.location or '' }}</td>

            <!-- Druckertyp -->
            <td>{{ p.printer_type or '' }}</td>

            <!-- Tasmota Host -->
            <td>{{ p.tasmota_host or '' }}</td>

            <!-- Enabled-Status -->
            <td class="text-center">
              {% if p.enabled %}
                <span class="badge bg-success">
                  {{ _('status_enabled') if _ else 'Aktiv' }}
                </span>
              {% else %}
                <span class="badge bg-secondary">
                  {{ _('status_disabled') if _ else 'Deaktiviert' }}
                </span>
              {% endif %}
            </td>

            <!-- Aktionen -->
            <td class="text-end">
              <a
                href="{{ url_for('printers.printer_edit', printer_id=p.id) }}"
                class="btn btn-outline-secondary btn-sm me-1"
              >
                {{ _('btn_edit') if _ else 'Bearbeiten' }}
              </a>
              <form
                action="{{ url_for('printers.printer_delete', printer_id=p.id) }}"
                method="post"
                class="d-inline"
                onsubmit="return confirm('{{ _('confirm_delete_printer') if _ else 'Drucker wirklich löschen?' }}');"
              >
                <button type="submit" class="btn btn-danger btn-sm">
                  {{ _('btn_delete') if _ else 'Löschen' }}
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card mt-3" id="printer-scan-card">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h3 class="h6 mb-0">{{ _('printer_scan_title') }}</h3>
    <button type="button" class="btn btn-outline-primary btn-sm" id="printerScanButton">
      {{ _('printer_scan_button') }}
    </button>
  </div>

  <div class="card-body">
    <p class="text-muted small mb-2">{{ _('printer_scan_description') }}</p>
    <div id="printerScanStatus" class="text-muted small mb-2" aria-live="polite">
      {{ _('printer_scan_status_idle') }}
    </div>
    <div id="printerScanLast" class="text-muted small mb-2">
      {{ _('printer_scan_last_label') }}
      <span id="printerScanLastValue">{{ _('printer_scan_last_unknown') }}</span>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0 d-none" id="printerScanTable">
        <thead>
          <tr>
            <th>{{ _('printer_scan_col_type') }}</th>
            <th>{{ _('col_link') }}</th>
            <th>{{ _('printer_scan_col_host') }}</th>
            <th>{{ _('printer_scan_col_ports') }}</th>
          </tr>
        </thead>
        <tbody id="printerScanBody"></tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  (function () {
    const scanButton = document.getElementById('printerScanButton');
    const scanStatus = document.getElementById('printerScanStatus');
    const scanTable = document.getElementById('printerScanTable');
    const scanBody = document.getElementById('printerScanBody');
    const scanLastValue = document.getElementById('printerScanLastValue');

    if (!scanButton || !scanStatus || !scanTable || !scanBody || !scanLastValue) return;

    const statusIdle = "{{ _('printer_scan_status_idle') }}";
    const statusRunning = "{{ _('printer_scan_status_running') }}";
    const statusDone = "{{ _('printer_scan_status_done') }}";
    const statusEmpty = "{{ _('printer_scan_status_empty') }}";
    const statusError = "{{ _('printer_scan_status_error') }}";
    const statusLastUnknown = "{{ _('printer_scan_last_unknown') }}";

    const storageResultsKey = 'printfleet-printer-scan-results';
    const storageLastKey = 'printfleet-printer-scan-last';

    const typeLabels = {
      "OctoPrint": "{{ _('backend_octoprint') }}",
      "Klipper": "{{ _('backend_moonraker') }}",
      "Elegoo Centurio": "{{ _('backend_centauri') }}"
    };

    function clearResults() {
      scanBody.innerHTML = '';
      scanTable.classList.add('d-none');
    }

    function formatScanTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      const lang = document.documentElement.lang || undefined;
      return date.toLocaleString(lang);
    }

    function updateLastScan(isoString) {
      const formatted = formatScanTime(isoString);
      scanLastValue.textContent = formatted || statusLastUnknown;
    }

    function safeStorageGet(key) {
      try {
        return localStorage.getItem(key);
      } catch (err) {
        return null;
      }
    }

    function safeStorageSet(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (err) {
        // ignore storage errors
      }
    }

    function saveScanState(results, isoString) {
      safeStorageSet(storageResultsKey, JSON.stringify(results));
      safeStorageSet(storageLastKey, isoString);
    }

    function loadScanState() {
      const last = safeStorageGet(storageLastKey);
      if (!last) {
        scanStatus.textContent = statusIdle;
        updateLastScan('');
        return;
      }

      updateLastScan(last);
      try {
        const raw = safeStorageGet(storageResultsKey);
        const results = raw ? JSON.parse(raw) : [];
        renderResults(Array.isArray(results) ? results : []);
      } catch (err) {
        scanStatus.textContent = statusIdle;
      }
    }

    function renderResults(results) {
      clearResults();
      if (!results.length) {
        scanStatus.textContent = statusEmpty;
        return;
      }

      function buildWebUrl(item) {
        const ip = item && item.ip ? item.ip : '';
        const ports = Array.isArray(item && item.ports) ? item.ports : [];
        if (!ip || ports.length === 0) return '';

        const preferred = [443, 80, 5000, 7125, 8080];
        let port = ports.find((p) => preferred.includes(p));
        if (!port) {
          port = ports[0];
        }

        const protocol = port === 443 ? 'https' : 'http';
        const omitPort = (protocol === 'https' && port === 443) || (protocol === 'http' && port === 80);
        return `${protocol}://${ip}${omitPort ? '' : ':' + port}`;
      }

      results.forEach((item) => {
        const row = document.createElement('tr');

        const typeCell = document.createElement('td');
        typeCell.textContent = typeLabels[item.type] || item.type || 'Unknown';

        const webCell = document.createElement('td');
        const webUrl = buildWebUrl(item);
        if (webUrl) {
          const link = document.createElement('a');
          link.className = 'btn btn-outline-primary btn-sm';
          link.href = webUrl;
          link.target = '_blank';
          link.rel = 'noreferrer';
          link.textContent = "{{ _('btn_open_web_ui') }}";
          webCell.appendChild(link);
        } else {
          webCell.textContent = '-';
        }

        const hostCell = document.createElement('td');
        hostCell.textContent = item.ip || '';

        const portsCell = document.createElement('td');
        portsCell.textContent = Array.isArray(item.ports) ? item.ports.join(', ') : '';

        row.appendChild(typeCell);
        row.appendChild(webCell);
        row.appendChild(hostCell);
        row.appendChild(portsCell);
        scanBody.appendChild(row);
      });

      scanTable.classList.remove('d-none');
      scanStatus.textContent = statusDone + ' (' + results.length + ')';
    }

    async function runScan() {
      scanButton.disabled = true;
      scanStatus.textContent = statusRunning;
      clearResults();
      saveScanState([], '');
      updateLastScan('');

      try {
        const response = await fetch("{{ url_for('printers.api_printer_scan') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (!response.ok || data.status !== 'ok') {
          scanStatus.textContent = statusError + (data.msg ? ' ' + data.msg : '');
          return;
        }
        const results = Array.isArray(data.results) ? data.results : [];
        const nowIso = new Date().toISOString();
        renderResults(results);
        updateLastScan(nowIso);
        saveScanState(results, nowIso);
      } catch (err) {
        scanStatus.textContent = statusError;
      } finally {
        scanButton.disabled = false;
        if (scanStatus.textContent === statusRunning) {
          scanStatus.textContent = statusError;
        }
      }
    }

    scanButton.addEventListener('click', runScan);
    loadScanState();
  })();
</script>
{% endblock %}

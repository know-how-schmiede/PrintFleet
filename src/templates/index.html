{% extends "base.html" %}

{% block title %}{{ _('page_overview_title') }}{% endblock %}

{% block content %}
  <table id="tbl">
    <thead>
      <tr>
        <th>{{ _('col_printer_name') }}</th>
        <th>{{ _('col_backend') }}</th>
        <th>{{ _('col_state') }}</th>
        <th>{{ _('col_filename') }}</th>
        <th style="min-width:160px">{{ _('col_progress') }}</th>
        <th>{{ _('col_elapsed') }}</th>
        <th>{{ _('col_eta') }}</th>
        <th>{{ _('col_hotend') }} ({{ _('col_hotend_target') }})</th>
        <th>{{ _('col_bed') }} ({{ _('col_bed_target') }})</th>
        <th>{{ _('col_last_update') }}</th>
        <th>{{ _('col_actions') }}</th>
        <th>{{ _('col_error') }}</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Dialog für detaillierte Fehlermeldungen -->
  <dialog id="errorDialog">
    <h3>{{ _('dialog_error_title') }}</h3>
    <pre id="errorDialogText" style="white-space: pre-wrap; max-width: 80vw; max-height: 60vh; overflow:auto;"></pre>
    <div style="text-align: right; margin-top: 1rem;">
      <button id="errorDialogCloseBtn" class="btn">
        {{ _('btn_close') }}
      </button>
    </div>
  </dialog>

<script>
// Übersetzte Status-Texte aus dem Backend
const STATE_LABELS = {
  "printing": "{{ _('state_printing') }}",
  "paused": "{{ _('state_paused') }}",
  "cancelled": "{{ _('state_cancelled') }}",
  "complete": "{{ _('state_complete') }}",
  "error": "{{ _('state_error') }}",
  "offline": "{{ _('state_offline') }}",
  "standby": "{{ _('state_standby') }}",
  "unknown": "{{ _('state_unknown') }}"
};

// Button-Text für Aktionen
const BTN_OPEN_WEB_UI   = "{{ _('btn_open_web_ui') }}";
const BTN_POWER_TOGGLE  = "{{ _('btn_power_toggle') }}"; // Fallback-/Unknown-Text

// Texte für Error-Spalte
const ERROR_SHORT_LABEL = "{{ _('printer_error_unreachable') }}";
const BTN_SHOW_ERROR_DETAILS = "{{ _('btn_show_error_details') }}";

function pctColor(p){
  if(p >= 80) return 'linear-gradient(90deg,#16a34a,#22c55e)'; // grün
  if(p >= 40) return 'linear-gradient(90deg,#ca8a04,#eab308)'; // gelb
  return 'linear-gradient(90deg,#dc2626,#ef4444)';             // rot
}

function toFixed1(x){
  return (typeof x === 'number' && isFinite(x)) ? x.toFixed(1) : (x ?? '');
}

// Error-Dialog Referenzen
const errorDialog        = document.getElementById('errorDialog');
const errorDialogText    = document.getElementById('errorDialogText');
const errorDialogCloseBtn = document.getElementById('errorDialogCloseBtn');

// Dialog-Eventhandling
if (errorDialog && errorDialogCloseBtn) {
  errorDialogCloseBtn.addEventListener('click', function () {
    errorDialog.close();
  });

  // Dialog schließen, wenn man außerhalb klickt
  errorDialog.addEventListener('click', function (event) {
    const rect = errorDialog.getBoundingClientRect();
    const isInDialog =
      rect.top <= event.clientY &&
      event.clientY <= rect.bottom &&
      rect.left <= event.clientX &&
      event.clientX <= rect.right;
    if (!isInDialog) {
      errorDialog.close();
    }
  });

  // Delegation für alle Error-Buttons in der Tabelle
  document.querySelector('#tbl tbody').addEventListener('click', function (event) {
    const btn = event.target.closest('.show-error-btn');
    if (!btn) return;
    const msg = btn.dataset.error || '';
    errorDialogText.textContent = msg;
    if (typeof errorDialog.showModal === 'function') {
      errorDialog.showModal();
    } else {
      alert(msg);
    }
  });
}

// Button-Text anhand Zustand setzen
function updatePowerButton(btn, state) {
  btn.dataset.state = state;  // 'ON', 'OFF', 'UNKNOWN'

  // zuerst alle Zustands-Klassen entfernen
  btn.classList.remove("state-on", "state-off", "state-unknown");

  if (state === 'ON') {
    btn.textContent = 'ON';
    btn.classList.add("state-on");

  } else if (state === 'OFF') {
    btn.textContent = 'OFF';
    btn.classList.add("state-off");

  } else {
    btn.textContent = '…';
    btn.classList.add("state-unknown");
  }
}

// Status für einen einzelnen Power-Button vom Server holen
async function initPowerButton(btn) {
  const id = btn.dataset.printerId;
  try {
    const res = await fetch(`/api/printer/${id}/power/status`);
    const data = await res.json();
    if (data.status === 'ok') {
      updatePowerButton(btn, data.state); // 'ON' oder 'OFF'
    } else {
      updatePowerButton(btn, 'UNKNOWN');
    }
  } catch (e) {
    console.error(e);
    updatePowerButton(btn, 'UNKNOWN');
  }
}

async function loadData(){
  try{
    const r = await fetch('/api/status', {cache:'no-store'});
    const data = await r.json();
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    const now = Math.floor(Date.now()/1000);

    (data || []).forEach(p => {
      // Fallbacks
      const printer_id   = p.id;
      const tasmota_host = p.tasmota_host || null;
      const name         = p.name || '';
      const backend      = p.backend || '';
      const state        = p.state || 'standby';
      const filename     = p.filename || '';
      const progress_pct = (typeof p.progress_pct === 'number' && isFinite(p.progress_pct)) ? p.progress_pct : 0;
      const elapsed_hms  = p.elapsed_hms || '';
      const eta_hms      = p.eta_hms || '';
      const hotend       = (typeof p.hotend === 'number') ? p.hotend : 0;
      const hotend_t     = (typeof p.hotend_t === 'number') ? p.hotend_t : 0;
      const bed          = (typeof p.bed === 'number') ? p.bed : 0;
      const bed_t        = (typeof p.bed_t === 'number') ? p.bed_t : 0;
      const last_update  = (typeof p.last_update === 'number') ? p.last_update : 0;
      const error        = p.error || '';
      const link         = p.link || '';

      const tr = document.createElement('tr');
      tr.className = state;

      const td = (t)=>{ const x=document.createElement('td'); x.textContent=t; return x; };
      const tdHTML = (h)=>{ const x=document.createElement('td'); x.innerHTML=h; return x; };

      const stateLabel = STATE_LABELS[state] || state;
      const badge = '<span class="badge ' + state + '">' + stateLabel + '</span>';

      // Fortschrittsbalken
      const progCell = document.createElement('td');
      const progWrap = document.createElement('div');
      progWrap.className = 'progress';
      const inner = document.createElement('div');
      inner.style.width = progress_pct + '%';
      inner.style.background = pctColor(progress_pct);
      progWrap.appendChild(inner);
      const label = document.createElement('div');
      label.style.fontSize='12px';
      label.style.marginTop='4px';
      label.textContent = (isFinite(progress_pct) ? progress_pct.toFixed(1) : '0.0') + '%';
      progCell.appendChild(progWrap);
      progCell.appendChild(label);

      // Aktionen
      const actions = document.createElement('td');
      actions.className = 'actions';

      // Web-UI öffnen
      if (link) {
        const a1 = document.createElement('a');
        a1.href = link;
        a1.target = '_blank';
        a1.className = 'btn';
        a1.textContent = BTN_OPEN_WEB_UI;
        actions.appendChild(a1);
      }

      // Power-Button, nur wenn eine Tasmota-IP hinterlegt ist
      if (tasmota_host) {
        const btnPower = document.createElement('button');
        btnPower.className = 'btn power-btn';
        btnPower.dataset.printerId = printer_id;
        btnPower.dataset.state = 'UNKNOWN';
        btnPower.textContent = '…';   // Platzhalter, bis Status geladen ist

        btnPower.addEventListener('click', async () => {
          const current = btnPower.dataset.state || 'UNKNOWN';

          // Sicherheitsabfrage nur beim Ausschalten
          if (current === 'ON') {
            const ok = confirm(
              "Drucker wirklich ausschalten?\n" +
              "Wenn gerade gedruckt wird, wird der Druck SOFORT abgebrochen!"
            );
            if (!ok) return;
          }

          try {
            const resp = await fetch(`/api/printer/${printer_id}/power/toggle`, {
              method: 'POST'
            });
            const data = await resp.json();
            if (data.status === 'ok') {
              // Neuen Zustand vom Server übernehmen
              updatePowerButton(btnPower, data.state);
            } else {
              alert("Fehler beim Schalten: " + (data.msg || "Unbekannt"));
            }
          } catch (e) {
            console.error(e);
            alert("Netzwerkfehler beim Schalten der Steckdose.");
          }
        });

        // initialen Zustand vom Server laden
        initPowerButton(btnPower);

        actions.appendChild(btnPower);
      }

      const last = last_update ? (now - last_update) : 0;
      const lastTxt = (last >= 0) ? (last + ' s') : '';

      // Error-Spalte: nur Kurztext + Button
      const errorCell = document.createElement('td');
      if (error) {
        const shortSpan = document.createElement('span');
        shortSpan.textContent = ERROR_SHORT_LABEL; // z.B. "Keine Verbindung"
        errorCell.appendChild(shortSpan);

        const space = document.createTextNode(' ');
        errorCell.appendChild(space);

        const btnDetails = document.createElement('button');
        btnDetails.type = 'button';
        btnDetails.className = 'btn btn-sm show-error-btn';
        btnDetails.textContent = BTN_SHOW_ERROR_DETAILS;
        // komplette Fehlermeldung im Dataset speichern
        btnDetails.dataset.error = error;
        errorCell.appendChild(btnDetails);
      } else {
        errorCell.textContent = ''; // oder '-' wenn du willst
      }

      tr.appendChild(td(name));
      tr.appendChild(td(backend));
      tr.appendChild(tdHTML(badge));
      tr.appendChild(td(filename));
      tr.appendChild(progCell);
      tr.appendChild(td(elapsed_hms));
      tr.appendChild(td(eta_hms));
      tr.appendChild(td(toFixed1(hotend) + ' / ' + toFixed1(hotend_t) + ' °C'));
      tr.appendChild(td(toFixed1(bed)    + ' / ' + toFixed1(bed_t)    + ' °C'));
      tr.appendChild(td(lastTxt));
      tr.appendChild(actions);
      tr.appendChild(errorCell);

      tbody.appendChild(tr);
    });
  } catch(e){
    console.error('fetch error', e);
  }
}

loadData();
setInterval(loadData, 5000);
</script>
{% endblock %}
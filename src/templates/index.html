{% extends "base.html" %}
{% block container_class %}container-fluid{% endblock %}

{% block title %}{{ _('page_overview_title') }}{% endblock %}

{% block content %}

<div class="card">
  <div class="card-body p-2">
    <div class="table-responsive">
      <table id="tbl" class="table table-striped table-hover table-sm align-middle mb-0">
        <thead>
          <tr>
            <!-- Name: immer sichtbar, mit "Alle anzeigen"-Auge -->
            <th data-col-key="name">
              <div class="col-toggle">
                <span>{{ _('col_printer_name') }}</span>
                <button
                  type="button"
                  id="showAllColumnsBtn"
                  class="btn btn-outline-secondary btn-sm btn-icon"
                  style="margin-left: 0.5rem;"
                  title="{{ _('btn_show_all_columns') if _ else 'Alle Spalten anzeigen' }}"
                  aria-label="{{ _('btn_show_all_columns') if _ else 'Alle Spalten anzeigen' }}"
                >
                  &#128065;
                </button>
              </div>
            </th>

            <th data-col-key="backend">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="backend" checked>
                {{ _('col_backend') }}
              </label>
            </th>

            <th data-col-key="state">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="state" checked>
                {{ _('col_state') }}
              </label>
            </th>

            <th data-col-key="filename">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="filename" checked>
                {{ _('col_filename') }}
              </label>
            </th>

            <th data-col-key="progress" style="min-width:160px;">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="progress" checked>
                {{ _('col_progress') }}
              </label>
            </th>

            <th data-col-key="elapsed">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="elapsed" checked>
                {{ _('col_elapsed') }}
              </label>
            </th>

            <th data-col-key="eta">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="eta" checked>
                {{ _('col_eta') }}
              </label>
            </th>

            <th data-col-key="hotend">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="hotend" checked>
                {{ _('col_hotend') }}
              </label>
            </th>

            <th data-col-key="bed">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="bed" checked>
                {{ _('col_bed') }}
              </label>
            </th>

            <th data-col-key="last_update">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="last_update" checked>
                {{ _('col_last_update') }}
              </label>
            </th>

            <th data-col-key="actions">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="actions" checked>
                {{ _('col_actions') }}
              </label>
            </th>

            <th data-col-key="error">
              <label class="col-toggle">
                <input type="checkbox" data-col-toggle="error" checked>
                {{ _('col_error') }}
              </label>
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Dialog für detaillierte Fehlermeldungen -->
<dialog id="errorDialog">
  <h3 class="h5">{{ _('dialog_error_title') }}</h3>
  <pre id="errorDialogText" style="white-space: pre-wrap; max-width: 80vw; max-height: 60vh; overflow:auto;"></pre>
  <div class="text-end mt-3">
    <button id="errorDialogCloseBtn" class="btn btn-secondary btn-sm">
      {{ _('btn_close') }}
    </button>
  </div>
</dialog>

<script>
// Übersetzte Status-Texte aus dem Backend
const STATE_LABELS = {
  "printing": "{{ _('state_printing') }}",
  "paused": "{{ _('state_paused') }}",
  "cancelled": "{{ _('state_cancelled') }}",
  "complete": "{{ _('state_complete') }}",
  "error": "{{ _('state_error') }}",
  "offline": "{{ _('state_offline') }}",
  "standby": "{{ _('state_standby') }}",
  "unknown": "{{ _('state_unknown') }}",
  "no_scanning": "{{ _('state_no_scanning') }}"
};

// Button-Text für Aktionen
const BTN_OPEN_WEB_UI   = "{{ _('btn_open_web_ui') }}";
const BTN_POWER_TOGGLE  = "{{ _('btn_power_toggle') }}"; // Fallback-/Unknown-Text

// Texte für Error-Spalte
const ERROR_SHORT_LABEL = "{{ _('printer_error_unreachable') }}";
const BTN_SHOW_ERROR_DETAILS = "{{ _('btn_show_error_details') }}";

// ---------------- Spalten-Sichtbarkeit ----------------

const COLUMN_STORAGE_KEY = 'printfleet_dashboard_columns';

// 'name' ist NICHT in der Liste -> Name ist immer sichtbar
const COLUMN_KEYS = [
  'backend',
  'state',
  'filename',
  'progress',
  'elapsed',
  'eta',
  'hotend',
  'bed',
  'last_update',
  'actions',
  'error'
];

function loadColumnPrefs() {
  try {
    const raw = localStorage.getItem(COLUMN_STORAGE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) {
    console.warn('column prefs parse failed', e);
    return null;
  }
}

function saveColumnPrefsFromUI() {
  const prefs = {};
  document.querySelectorAll('input[data-col-toggle]').forEach(cb => {
    const key = cb.getAttribute('data-col-toggle');
    prefs[key] = cb.checked;
  });
  try {
    localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(prefs));
  } catch (e) {
    console.warn('column prefs save failed', e);
  }
}

function applyColumnVisibility() {
  const table = document.getElementById('tbl');
  if (!table) return;

  const prefs = loadColumnPrefs();
  const hasPrefs = !!prefs;

  COLUMN_KEYS.forEach(key => {
    let visible;
    if (hasPrefs && Object.prototype.hasOwnProperty.call(prefs, key)) {
      visible = !!prefs[key];
    } else {
      const cb = document.querySelector('input[data-col-toggle="' + key + '"]');
      visible = cb ? cb.checked : true;
    }

    const cb = document.querySelector('input[data-col-toggle="' + key + '"]');
    if (cb) cb.checked = visible;

    const cells = table.querySelectorAll('[data-col-key="' + key + '"]');
    cells.forEach(cell => {
      cell.style.display = visible ? '' : 'none';
    });
  });
}

// Event-Handler für Checkboxen
document.querySelectorAll('input[data-col-toggle]').forEach(cb => {
  cb.addEventListener('change', () => {
    saveColumnPrefsFromUI();
    applyColumnVisibility();
  });
});

// Button "Alle anzeigen" im Name-Header
const showAllBtn = document.getElementById('showAllColumnsBtn');
if (showAllBtn) {
  showAllBtn.addEventListener('click', () => {
    document.querySelectorAll('input[data-col-toggle]').forEach(cb => {
      cb.checked = true;
    });
    saveColumnPrefsFromUI();
    applyColumnVisibility();
  });
}

// Beim ersten Laden: gespeicherte Einstellungen anwenden
applyColumnVisibility();

// ---------------- Bootstrap-Style-Helfer ----------------

function progressBarClass(p) {
  if (p >= 80) return 'bg-success';
  if (p >= 40) return 'bg-warning text-dark';
  return 'bg-danger';
}

function stateBadgeClass(state) {
  switch (state) {
    case 'printing':  return 'bg-success';
    case 'paused':    return 'bg-warning text-dark';
    case 'cancelled': return 'bg-secondary';
    case 'complete':  return 'bg-success';
    case 'error':     return 'bg-danger';
    case 'offline':   return 'bg-secondary';
    case 'standby':   return 'bg-info text-dark';
    case 'no_scanning': return 'bg-secondary';
    default:          return 'bg-light text-dark';
  }
}

function toFixed1(x){
  return (typeof x === 'number' && isFinite(x)) ? x.toFixed(1) : (x ?? '');
}

// Error-Dialog Referenzen
const errorDialog        = document.getElementById('errorDialog');
const errorDialogText    = document.getElementById('errorDialogText');
const errorDialogCloseBtn = document.getElementById('errorDialogCloseBtn');

// Dialog-Eventhandling
if (errorDialog && errorDialogCloseBtn) {
  errorDialogCloseBtn.addEventListener('click', function () {
    errorDialog.close();
  });

  errorDialog.addEventListener('click', function (event) {
    const rect = errorDialog.getBoundingClientRect();
    const isInDialog =
      rect.top <= event.clientY &&
      event.clientY <= rect.bottom &&
      rect.left <= event.clientX &&
      event.clientX <= rect.right;
    if (!isInDialog) {
      errorDialog.close();
    }
  });

  document.querySelector('#tbl tbody').addEventListener('click', function (event) {
    const btn = event.target.closest('.show-error-btn');
    if (!btn) return;
    const msg = btn.dataset.error || '';
    errorDialogText.textContent = msg;
    if (typeof errorDialog.showModal === 'function') {
      errorDialog.showModal();
    } else {
      alert(msg);
    }
  });
}

// Button-Text anhand Zustand setzen (mit Bootstrap-Farben)
function updatePowerButton(btn, state) {
  btn.dataset.state = state;

  btn.classList.remove("btn-success", "btn-outline-secondary", "btn-danger");

  if (state === 'ON') {
    btn.textContent = 'ON';
    btn.classList.add("btn-success");
  } else if (state === 'OFF') {
    btn.textContent = 'OFF';
    btn.classList.add("btn-outline-secondary");
  } else {
    btn.textContent = '…';
    btn.classList.add("btn-outline-secondary");
  }
}

// Status für einen einzelnen Power-Button vom Server holen
async function initPowerButton(btn) {
  const id = btn.dataset.printerId;
  try {
    const res = await fetch(`/api/printer/${id}/power/status`);
    const data = await res.json();
    if (data.status === 'ok') {
      updatePowerButton(btn, data.state);
    } else {
      updatePowerButton(btn, 'UNKNOWN');
    }
  } catch (e) {
    console.error(e);
    updatePowerButton(btn, 'UNKNOWN');
  }
}

function removeFileExtension(name) {
  if (!name) return '';
  const idx = name.lastIndexOf('.');
  if (idx > 0) return name.substring(0, idx);
  return name;
}

function shortenFileName(name, max = 22) {
  if (!name) return '';
  if (name.length <= max) return name;
  return name.substring(0, max - 1) + '…';
}

function pctColor(p) {
  if (p >= 80) return '#16a34a';      // grün
  if (p >= 40) return '#eab308';      // gelb
  return '#dc2626';                   // rot
}


async function loadData(){
  try{
    const r = await fetch('/api/status', {cache:'no-store'});
    const data = await r.json();
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    const now = Math.floor(Date.now()/1000);

    (data || []).forEach(p => {
      const printer_id   = p.id;
      const name         = p.name || '';
      const location     = p.location || '';
      const backend      = p.backend || '';
      const state        = p.state || 'standby';
      const noScanning   = !!p.no_scanning || state === 'no_scanning';
      const stateKey     = noScanning ? 'no_scanning' : state;
      const link         = p.link || '';

      const tasmota_host = p.tasmota_host || null;
      const filename     = noScanning ? '' : (p.filename || '');
      const progress_pct = noScanning ? 0 : ((typeof p.progress_pct === 'number' && isFinite(p.progress_pct)) ? p.progress_pct : 0);
      const elapsed_hms  = noScanning ? '' : (p.elapsed_hms || '');
      const eta_hms      = noScanning ? '' : (p.eta_hms || '');
      const hotend       = noScanning ? null : ((typeof p.hotend === 'number') ? p.hotend : 0);
      const hotend_t     = noScanning ? null : ((typeof p.hotend_t === 'number') ? p.hotend_t : 0);
      const bed          = noScanning ? null : ((typeof p.bed === 'number') ? p.bed : 0);
      const bed_t        = noScanning ? null : ((typeof p.bed_t === 'number') ? p.bed_t : 0);
      const last_update  = noScanning ? 0 : ((typeof p.last_update === 'number') ? p.last_update : 0);
      const error        = noScanning ? '' : (p.error || '');

      const tr = document.createElement('tr');
      tr.className = stateKey;

      const td = (t, key)=>{ 
        const x=document.createElement('td'); 
        x.textContent=t; 
        if (key) x.dataset.colKey = key;
        return x; 
      };
      const tdHTML = (h, key)=>{ 
        const x=document.createElement('td'); 
        x.innerHTML=h; 
        if (key) x.dataset.colKey = key;
        return x; 
      };

      const stateLabel = STATE_LABELS[stateKey] || stateKey;
      const badge = '<span class="badge ' + stateBadgeClass(stateKey) + '">' + stateLabel + '</span>';

      // Fortschrittsbalken
      let progCell;
      if (noScanning) {
        progCell = td('', 'progress');
      } else {
        progCell = document.createElement('td');
        progCell.dataset.colKey = 'progress';

        const progWrap = document.createElement('div');
        progWrap.className = 'dashboard-progress-wrap';

        const inner = document.createElement('div');
        inner.className = 'dashboard-progress-inner';
        inner.style.width = progress_pct + '%';
        inner.style.background = pctColor(progress_pct);

        // Prozentzahl direkt nebendran statt darunter
        const label = document.createElement('span');
        label.textContent = (isFinite(progress_pct) ? progress_pct.toFixed(1) : '0.0') + '%';
        label.style.marginLeft = '6px';
        label.style.whiteSpace = 'nowrap';

        progWrap.appendChild(inner);
        progCell.appendChild(progWrap);
        progCell.appendChild(label);
      }


      // Aktionen
      const actions = document.createElement('td');
      actions.className = 'actions';
      actions.dataset.colKey = 'actions';

      if (link) {
        const a1 = document.createElement('a');
        a1.href = link;
        a1.target = '_blank';
        a1.className = 'btn btn-primary btn-sm me-1';
        a1.textContent = BTN_OPEN_WEB_UI;
        actions.appendChild(a1);
      }

      if (tasmota_host) {
        const btnPower = document.createElement('button');
        btnPower.className = 'btn btn-outline-secondary btn-sm power-btn';
        btnPower.dataset.printerId = printer_id;
        btnPower.dataset.state = 'UNKNOWN';
        btnPower.textContent = '…';

        btnPower.addEventListener('click', async () => {
          const current = btnPower.dataset.state || 'UNKNOWN';

          if (current === 'ON') {
            const ok = confirm(
              "Drucker wirklich ausschalten?\n" +
              "Wenn gerade gedruckt wird, wird der Druck SOFORT abgebrochen!"
            );
            if (!ok) return;
          }

          try {
            const resp = await fetch(`/api/printer/${printer_id}/power/toggle`, {
              method: 'POST'
            });
            const data = await resp.json();
            if (data.status === 'ok') {
              updatePowerButton(btnPower, data.state);
            } else {
              alert("Fehler beim Schalten: " + (data.msg || "Unbekannt"));
            }
          } catch (e) {
            console.error(e);
            alert("Netzwerkfehler beim Schalten der Steckdose.");
          }
        });

        initPowerButton(btnPower);
        actions.appendChild(btnPower);
      }

      const last = last_update ? (now - last_update) : 0;
      const lastTxt = noScanning ? '' : ((last >= 0) ? (last + ' s') : '');

      // Error-Spalte
      const errorCell = document.createElement('td');
      errorCell.dataset.colKey = 'error';
      if (error && !noScanning) {
        const shortSpan = document.createElement('span');
        shortSpan.textContent = ERROR_SHORT_LABEL;
        errorCell.appendChild(shortSpan);

        const space = document.createTextNode(' ');
        errorCell.appendChild(space);

        const btnDetails = document.createElement('button');
        btnDetails.type = 'button';
        btnDetails.className = 'btn btn-outline-secondary btn-sm show-error-btn';
        btnDetails.textContent = BTN_SHOW_ERROR_DETAILS;
        btnDetails.dataset.error = error;
        errorCell.appendChild(btnDetails);
      } else {
        errorCell.textContent = '';
      }

      const nameCell = document.createElement('td');
      nameCell.dataset.colKey = 'name';
      const nameSpan = document.createElement('span');
      nameSpan.textContent = name;
      nameCell.appendChild(nameSpan);
      if (location) {
        const locationSpan = document.createElement('span');
        locationSpan.className = 'text-muted small d-block';
        locationSpan.textContent = location;
        nameCell.appendChild(locationSpan);
      }
      tr.appendChild(nameCell);
      tr.appendChild(td(backend, 'backend'));
      tr.appendChild(tdHTML(badge, 'state'));
      
      // Filename kürzen & Suffix entfernen
      const cleanName = removeFileExtension(filename);
      const shortName = shortenFileName(cleanName, 22);
      const tdFilename = td(shortName, 'filename');
      tdFilename.title = filename;  // Tooltip -> vollständiger Name
      tr.appendChild(tdFilename);

      tr.appendChild(progCell);
      const hotendTxt = noScanning ? '' : (toFixed1(hotend) + ' / ' + toFixed1(hotend_t) + ' °C');
      const bedTxt = noScanning ? '' : (toFixed1(bed)    + ' / ' + toFixed1(bed_t)    + ' °C');

      tr.appendChild(td(elapsed_hms, 'elapsed'));
      tr.appendChild(td(eta_hms, 'eta'));
      tr.appendChild(td(hotendTxt, 'hotend'));
      tr.appendChild(td(bedTxt, 'bed'));
      tr.appendChild(td(lastTxt, 'last_update'));
      tr.appendChild(actions);
      tr.appendChild(errorCell);

      tbody.appendChild(tr);
    });

    applyColumnVisibility();

  } catch(e){
    console.error('fetch error', e);
  }
}

loadData();
setInterval(loadData, 5000);
</script>
{% endblock %}

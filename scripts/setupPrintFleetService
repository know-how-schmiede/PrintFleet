#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
default_install_dir="$(cd "${script_dir}/.." && pwd)"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  cat <<'EOF'
Usage: setupPrintFleetService [options]

Options:
  --install-dir=PATH     Install directory (default: repo root)
  --service-user=USER    Service user (default: printfleet)
  --service-name=NAME    systemd service name (default: printfleet)
  --non-interactive      Use defaults for missing values (no prompts)
EOF
  exit 0
fi

if [[ "$(id -u)" -ne 0 ]]; then
  echo "ERROR: Run as root (sudo -i)."
  exit 1
fi

if ! command -v systemctl >/dev/null 2>&1; then
  echo "ERROR: systemctl not found. This container must use systemd."
  exit 1
fi

INSTALL_DIR=""
SERVICE_USER=""
SERVICE_NAME=""
NON_INTERACTIVE=0

for arg in "$@"; do
  case "$arg" in
    --install-dir=*)
      INSTALL_DIR="${arg#*=}"
      ;;
    --service-user=*)
      SERVICE_USER="${arg#*=}"
      ;;
    --service-name=*)
      SERVICE_NAME="${arg#*=}"
      ;;
    --non-interactive)
      NON_INTERACTIVE=1
      ;;
    *)
      echo "Unknown option: $arg"
      exit 1
      ;;
  esac
done

prompt() {
  local label="$1"
  local default="$2"
  local value=""
  if [[ "$NON_INTERACTIVE" -eq 1 ]]; then
    printf '%s' "$default"
    return
  fi
  read -r -p "${label} [${default}]: " value
  if [[ -z "$value" ]]; then
    value="$default"
  fi
  printf '%s' "$value"
}

INSTALL_DIR="${INSTALL_DIR:-$(prompt "Install directory" "$default_install_dir")}"
SERVICE_USER="${SERVICE_USER:-$(prompt "Service user" "printfleet")}"
SERVICE_NAME="${SERVICE_NAME:-$(prompt "Service name" "printfleet")}"

PY_BIN="${INSTALL_DIR}/.venv/bin/python"
APP_FILE="${INSTALL_DIR}/src/PrintFleetDB.py"

if [[ ! -f "$APP_FILE" ]]; then
  echo "ERROR: PrintFleet not found at ${APP_FILE}"
  exit 1
fi

if [[ ! -x "$PY_BIN" ]]; then
  echo "ERROR: Python venv not found at ${PY_BIN}"
  exit 1
fi

if ! id -u "$SERVICE_USER" >/dev/null 2>&1; then
  useradd -m -s /bin/bash "$SERVICE_USER"
fi

chown -R "${SERVICE_USER}:${SERVICE_USER}" "$INSTALL_DIR"

SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=PrintFleet Service
After=network.target

[Service]
Type=simple
User=${SERVICE_USER}
Group=${SERVICE_USER}
WorkingDirectory=${INSTALL_DIR}/src
ExecStart=${PY_BIN} ${APP_FILE}
Restart=on-failure
RestartSec=5
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now "$SERVICE_NAME"

echo "Service installed and started: ${SERVICE_NAME}"
echo "Status: systemctl status ${SERVICE_NAME}"
